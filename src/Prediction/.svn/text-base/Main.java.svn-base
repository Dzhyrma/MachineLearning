package Prediction;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Vector;

import weka.classifiers.Classifier;
import weka.core.Instances;
import weka.core.converters.ConverterUtils.DataSource;
import constants.Constants;

public class Main {
	private static Vector<Classifier> classifiers;
	private static Vector<ClassifierPrediction> classifierPredictionMusic = new Vector<ClassifierPrediction>();
	private static Vector<ClassifierPrediction> classifierPredictionSpeech = new Vector<ClassifierPrediction>();

	// ====================================================================================//
	// Main //
	// ====================================================================================//
	public static void main(String[] args) throws Exception {
		boolean isMusic = true;
		System.out
				.println("\n\n=================== Classifiers =============\n\n");
		classifiers = loadClassifierVector(isMusic);
		System.out
				.println("\n\n=================== Predictions =============\n\n");
		classifierPredictionMusic = loadPredictionVector(isMusic);
		System.out
				.println("\n\n=================== Music ===================\n\n");
		Instances[] musicTestData = loadTestData(isMusic, Constants.FILE_NAMES.length);
		evaluate(musicTestData, isMusic);
		savePredictionVector(classifierPredictionMusic, isMusic);
		isMusic = false;
		System.out
				.println("\n\n=================== Classifiers =============\n\n");
		classifiers = loadClassifierVector(isMusic);
		System.out
				.println("\n\n=================== Predictions =============\n\n");
				classifierPredictionMusic = loadPredictionVector(isMusic);
		System.out
				.println("\n\n=================== Speech ==================\n\n");
		
		Instances[] speechTestData = loadTestData(isMusic, Constants.FILE_NAMES.length);
		evaluate(speechTestData, isMusic);
		savePredictionVector(classifierPredictionSpeech, isMusic);
	}

	// ====================================================================================//
	// loadTestData //
	// ====================================================================================//
	public static Instances[] loadTestData(boolean isMusic, int num) {
		try {
			Instances[] res = new Instances[num];
			System.out.println("\n# Loading test data");
			for (int i = 0; i < num; i++) {
				String fileName = (isMusic ? Constants.MUSIC_FOLDER : Constants.SPEECH_FOLDER)
						+ Constants.FILE_NAMES[i];
				DataSource source = new DataSource(fileName);
				res[i] = source.getDataSet();
				if (res[i].classIndex() == -1)
					res[i].setClassIndex(res[i].numAttributes() - 1);
				System.out.println("\n# " + fileName + " is loaded...");
			}
			return res;
		} catch (Exception e) {
		}
		return null;
	}

	// ====================================================================================//
	// loadData //
	// ====================================================================================//
	public static Instances loadData(String fileName) {
		try {
			System.out.println("\n# Loading data");
			DataSource source = new DataSource(fileName);
			Instances data = source.getDataSet();
			if (data.classIndex() == -1)
				data.setClassIndex(data.numAttributes() - 1);
			return data;
		} catch (Exception e) {
		}
		return null;
	}

	// ====================================================================================//
	// Evaluate //
	// ====================================================================================//
	public static void evaluate(Instances[] testData, boolean isMusic) {
		if (isMusic && classifierPredictionMusic == null)
			classifierPredictionMusic = new Vector<ClassifierPrediction>();
		else if (!isMusic && classifierPredictionSpeech == null)
			classifierPredictionSpeech = new Vector<ClassifierPrediction>();
		for (Classifier classifier : classifiers) {
			ClassifierPrediction classifierPrediction = new ClassifierPrediction(classifier);
			for (int i = 0; i < testData.length; i++) {
				Vector<Boolean> predictionInstances = new Vector<Boolean>();
				try {
					for (int j = 0; j < testData[i].numInstances(); j++) {
						predictionInstances
								.add(classifier.classifyInstance(testData[i]
										.get(j)) == 1 ? true : false);
					}
					
				} catch (Exception ex) {
					System.out.println("Prediction of the Instance problem!");
				}
				classifierPrediction.addPrediction(Constants.FILE_NAMES[i],
						predictionInstances);
				System.out.println("File " + Constants.FILE_NAMES[i] + " is finished...");
			}
			if (isMusic)
				classifierPredictionMusic.add(classifierPrediction);
			else
				classifierPredictionSpeech.add(classifierPrediction);
			System.out.println("Classifier: " + classifier + "\n Finished...");
		}

	}

	// ====================================================================================//
	// LoadClassifierVector //
	// ====================================================================================//
	@SuppressWarnings("unchecked")
	private static Vector<Classifier> loadClassifierVector(boolean isMusic) {
		Vector<Classifier> vec = new Vector<Classifier>();
		FileInputStream fis = null;
		ObjectInputStream in = null;
		try {
			fis = new FileInputStream(isMusic ? "MusicClassifiersJRip.obj"
					: "SpeechClassifiersJRip.obj");
			in = new ObjectInputStream(fis);
			vec = (Vector<Classifier>) in.readObject();
			in.close();
			return vec;
		} catch (Exception e) {
			System.out.println(e.getMessage());
		}
		return null;
	}
	// ====================================================================================//
	// LoadPredictionVector //
	// ====================================================================================//
	@SuppressWarnings("unchecked")
	private static Vector<ClassifierPrediction> loadPredictionVector(boolean isMusic) {
		Vector<ClassifierPrediction> vec = new Vector<ClassifierPrediction>();
		FileInputStream fis = null;
		ObjectInputStream in = null;
		try {
			fis = new FileInputStream(isMusic ? "MusicPredictions.obj"
					: "SpeechPredictions.obj");
			in = new ObjectInputStream(fis);
			vec = (Vector<ClassifierPrediction>) in.readObject();
			in.close();
			return vec;
		} catch (Exception e) {
			System.out.println(e.getMessage());
		}
		return null;
	}
	private static void savePredictionVector(Vector<ClassifierPrediction> classifierPredictions, boolean isMusic)
	{
		String fileName = isMusic ? "MusicPredictions.obj"
				: "SpeechPredictions.obj";
		System.out.println("# Serializing prediction Object into " + fileName);
		FileOutputStream fos = null;
		ObjectOutputStream out = null;
		//evaluations = readEvaluationsVector();
		if (classifierPredictions == null)
			classifierPredictions = new Vector<ClassifierPrediction>();
		//evaluations.add(new Pair<Evaluation, Classifier>(evaluation, classifier));
		try {
			fos = new FileOutputStream(fileName);
			out = new ObjectOutputStream(fos);
			out.writeObject(classifierPredictions);
			out.close();
			System.out.println("# Prediction Map Persisted with size: "
					+ classifierPredictions.size());
		} catch (Exception ex) {
			ex.printStackTrace();
		}
	}
}
